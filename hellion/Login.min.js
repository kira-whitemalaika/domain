
AddFactor=(function()
{var _FORM_SELECT_TYPE=1;var _FORM_INSTALL_AUTH=2;var _FORM_SETUP_AUTH=3;var _FORM_VERIFY_MOBILE=4;var _FORM_MOBILE_HELP=5;var _FORM_SETUP_COMPLETE=6;var current_types={}
var default_form_title=$('#contentContainer h3').html();var _init=function(){_bind_select_type();}
var _show_select_type=function(){var q='';for(key in current_types)
{val=current_types[key];q+=q==''?'?':'&';q+=key+'='+val;}
_get({'type':_FORM_SELECT_TYPE,'query':q,'success':function(data)
{_bind_select_type();},'error':function()
{}});}
var _bind_select_type=function()
{if($('li[id=phone]').is(':visible'))
{$('#phone_no').focus();}
$('input[name=authType]').change(function(e)
{if($(this).val()=='p_sms')
{$('li[id=phoneType]').hide();$('li[id=phone]').show();$('input[id=phone_no]').focus();}
else if($(this).val()=='p_auth')
{Forms.hide_error();$('li[id=phone]').hide();$('li[id=phoneType]').show();}});$('#submitBtn').click(function(e)
{current_types={'authType':$('input[name=authType]:checked').val()?$('input[name=authType]:checked').val():'p_auth','phoneType':phoneType=$('input[name=phoneType]:checked').val()}
if(current_types.authType=='p_sms')
{var phone_number=$('input[id=phone_no]').val();if(_validate_phone(phone_number))
{result=NewFactor.sms(phone_number);if(result.success)
{factor_id=result.data;_show_verify_mobile(factor_id,result.display_name);}
else
{Forms.show_error(translate_dict.INVALID_PHONE,"phone_no");}}
else
{Forms.show_error(translate_dict.INVALID_PHONE,"phone_no");}}
else if(current_types.authType=='p_auth')
{_show_install_auth();}
return false;});}
var _show_install_auth=function()
{_get({'type':_FORM_INSTALL_AUTH,'query':'?type='+current_types['phoneType'],'success':function(data)
{$('#submitBtn').click(function()
{result=NewFactor.authenticator();if(result.success)
{data=result.data;_show_setup_auth(data.factor_id,data.secret_key,data.qrcode);}
else
{}
return false;});$('#cancelLink').click(function()
{_show_select_type();return false;});},'error':function()
{}});}
var _show_setup_auth=function(factor_id,secretKey,qrCode)
{_get({'type':_FORM_SETUP_AUTH,'query':'?type='+current_types['phoneType'],'success':function()
{$('.secretkey').text(secretKey);var img=$(document.createElement('img')).addClass('qr-code no-anti-alias');img.attr('src','data:image/png;base64,'+qrCode);$('.qr-code-container').append(img);$('#totp').focus();$('#cantScanBarcode').click(function()
{if($('#noCodeList').is(':visible'))
{$('.checkbox_link span').removeClass('uxicon-check-box green-checked-box');$('.checkbox_link span').addClass('uxicon-box gray-check-box');$('#noCodeList').hide();$('.qr-code-container').show();$('input[name=totp]').focus();}
else
{$('.checkbox_link span').removeClass('uxicon-box gray-check-box');$('.checkbox_link span').addClass('uxicon-check-box green-checked-box');$('#noCodeList').show();$('.qr-code-container').hide();$('input[name=totp]').focus();}
return false;});$('#submitBtn').click(function()
{var totp=$('input[name=totp]').val()
valid=false;rc='';if(_validate_totp(totp))
{result=NewFactor.verify(factor_id,totp);if(result.valid)
{valid=true;rc=result.rc;}}
if(valid)
{_show_setup_complete(rc);}
else
{Forms.show_error(translate_dict.INVALID_CODE,"totp");}
return false;});$('#cancelLink').click(function()
{_show_install_auth();return false;});},'error':function()
{}});}
var _show_verify_mobile=function(factor_id,display_name)
{_get({'type':_FORM_VERIFY_MOBILE,'success':function()
{$('#multifactor-form-desc').each(function()
{$(this).text($(this).text()+' '+display_name+'.');});$('#totp').focus();$('#noCode').click(function(){_show_mobile_help();return false;});$('#submitBtn').click(function(){totp=$('input[name=totp]').val()
valid=false;rc='';if(_validate_totp(totp))
{result=NewFactor.verify(factor_id,totp);if(result.valid)
{valid=true;rc=result.rc;}}
if(valid)
{_show_setup_complete(rc);}
else
{Forms.show_error(translate_dict.INVALID_CODE,"totp");}
return false;});},'error':function()
{}});}
var _show_mobile_help=function()
{_get({'type':_FORM_MOBILE_HELP,'success':function()
{$('#cancelLink').click(function()
{_show_select_type();return false;});},'error':function()
{}});}
var _show_setup_complete=function(rc)
{_get({'type':_FORM_SETUP_COMPLETE,'query':'?type='+current_types['authType'],'success':function()
{if(rc.replace(/\s/g,'')!='')
{$('.new-recovery-code-container').text(rc);$('.new-recovery-code-instructions').show();}
$('#submitBtn').click(function()
{current_types={};_show_select_type();return false;});},'error':function()
{}});}
var _validate_phone=function(val)
{return val.replace(/\s/g,'')!='';}
var _validate_totp=function(val)
{return val.replace(/\s/g,'')!=''&&val.length==6}
var _get=function(props,params)
{var search=document.location.search;if(!props.query)
{props.query=search;}
else if(search)
{props.query+=props.query?'&':'?';props.query+=search.substr(1,search.length-1)}
$.ajax({'type':typeof(params)=='undefined'?'GET':'POST','dataType':'json','cache':false,'async':true,'data':typeof(params)=='undefined'?'':params,'url':'/'+Globals.version+'/account/factor/add/form/'+props.type+props.query,'success':function(data)
{if(data.type=='error'){if(typeof(props.error)=="function"){props.error(data);}}else{Forms.hide_message();Forms.hide_error();$('#formContainer').empty();if(typeof(data.title)!='undefined'){$("#formContainer").append("<h2 id=\"formTitle\">"+data.title+"</h2>");}else{$("#formContainer").append(default_form_title);}
$('#formContainer').append($(data.data));if(typeof(props.success)=="function")
{props.success(data)}}},'error':function(data){props.error(data);}});}
return{init:function()
{_init();}}})();NewFactor=(function()
{var _ERROR_NOT_AUTHORIZED=-101
var _ERROR_FACTOR_HOLD=-102
var _ERROR_NOT_2FA=-103
var _add=function(data)
{success=false;resultData=null;code=-99;name='';display_name='';url='/'+Globals.version+'/account/factor/add/new';$.ajax({type:'POST',url:url,dataType:'json',cache:false,async:false,data:data,success:function(response)
{if(typeof(response.type)!='undefined'&&response.type!='error')
{success=true;resultData=response.data;code=1;display_name=response.name;}
else
{success=false;code=response.code}}});ret={success:success,data:resultData,code:code,display_name:display_name}
console.log(ret);return ret;}
var _verify=function(factor_id,password)
{valid=false;rc='';url='/'+Globals.version+'/account/factor/add/verify';data={factor_id:factor_id,password:password}
$.ajax({type:'POST',url:url,dataType:'json',cache:false,async:false,data:data,success:function(data)
{if(typeof(data.code)!='undefined'&&data.code==1)
{valid=true;if(typeof(data.rc)!='undefined'&&data.rc)
{rc=data.rc;}}}});return{valid:valid,rc:rc}}
return{sms:function(phone_number)
{data={type:'sms',phone_number:phone_number}
ret=_add(data);console.log(ret);return ret;},authenticator:function()
{data={type:'authenticator'}
return _add(data);},verify:function(factor_id,password)
{return _verify(factor_id,password);}}})();
CreateAccount=(function(){var error_map;var isProcessing=false;var init=function(){$("#create_email").focus();$("#submitBtn").click(validateForm);$("#create_username").on('input propertychange',usernameListen);$("#create_pin").on('keydown',restrictPin);$("#create_pin").on('paste',restrictPinPaste);$("#create_email").on('keyup',Forms.hide_error("create_email"));$("#create_username").on('keyup',Forms.hide_error("create_username"));$("#create_password").on('keyup',Forms.hide_error("create_password"));$("#create_pin").on('keyup',Forms.hide_error("create_pin"));setupValidators();Forms.showOrHidePassword("hide","create_password",_addPasswordValidator);error_map={'create_email':{'invalid':translate_dict['INVALID_EMAIL_FORMAT'],'missing':translate_dict['EMAIL_REQUIRED']},'create_username':{'invalid':translate_dict['INVALID_USERNAME'],'missing':translate_dict['USERNAME_REQUIRED'],'taken':translate_dict['USERNAME_IN_USE'],'numeric':translate_dict['USERNAME_ALL_NUMERIC']},'create_password':{'invalid':translate_dict['INVALID_PASSWORD'],'missing':translate_dict['PASSWORD_REQUIRED'],'matches_username':translate_dict['PASSWORD_MATCHES_USERNAME'],'to_short':translate_dict['PASSWORD_TO_SHORT'],'blacklisted':translate_dict['RESERVED_WORD_PASSWORD']},'create_pin':{'invalid':translate_dict['INVALID_PIN'],'missing':translate_dict['PIN_REQUIRED'],'sequential':translate_dict['PIN_IS_SEQUENTIAL'],'repeated':translate_dict['PIN_REPEATED_DIGIT']},'default':translate_dict['ERROR_MSG_DEFAULT']};};var validateForm=function(event){var inputs=$("#create_account_form").find('input');for(var i=0;i<inputs.length;i++)
{var input=$(inputs[i]);if(input.val()=="")
{return _setError(input.attr('id'),'missing');}
switch(input.attr('id'))
{case'create_email':if(!input.val().match("@")||!input.val().match(/\.{1,}/))
{return _setError(input.attr('id'),'invalid');}
break;case'create_username':if($.isNumeric(input.val()))
{return _setError(input.attr('id'),'numeric');}
break;case'create_password':if(input.val()==$("#create_username").val())
{return _setError(input.attr('id'),'matches_username');}
break;case'create_pin':if(!$.isNumeric(input.val()))
{return_setError(input.attr('id'),'invalid');}}}
_submitForm(event);return false;};var _submitForm=function(event){$("#submitBtn").addClass('disabled');var json={};$("#create_account_form").find('input').each(function(i,elm){json[$(elm).attr('name')]=$(elm).attr('value');});isProcessing=true;$("#contentContainer").sfMsgOverlay({'message':translate_dict['PROCESSING']});$.ajax({"url":$("#create_account_form").attr('action'),"data":json,"success":_handleFormResponse,"error":function(jqXHR,textStatus,errorThrown){$("#submitBtn").removeClass('disabled');},"type":"POST"});return false;};var _handleFormResponse=function(data)
{$("#submitBtn").removeClass('disabled');if(data.error)
{isProcessing=false;$("#contentContainer").sfMsgOverlay('destroy');if(data.error.id)
{_setError(data.error.id,data.error.reason);}
else
{_setError('',error_map[data.error.reason]);}
return false;}
else
{document.location=data.response;}};var _setError=function(id,reason){Forms.show_error(error_map[id][reason],id);return false;};var _clearError=function()
{Forms.hide_error();};var _addPasswordValidator=function(elm){var notStartOrEndWithSpace={msg:function(me,settings){return translate_dict['NOT_BEGIN_OR_END_WITH_SPACE']},test:function(me,text,settings){return!text.match(/^\s|\s$/);}};var minLength={msg:function(me,settings){return translate_dict['PASSWORD_TO_SHORT']},test:function(me,text,settings){return text.length>=settings.minLength;}};if(!elm)
{elm=$('#create_password');}
elm.sfValidator({minLength:9,maxLength:50,inputExp:/.*/gi,rules:[notStartOrEndWithSpace,$.fn.sfValidator.rules.lowerCase,$.fn.sfValidator.rules.upperCase,$.fn.sfValidator.rules.hasNum,minLength],onTest:isReady});};var setupValidators=function(){var fourDigitOnly={msg:function(me,settings){return translate_dict['PIN_MUST_BE_FOUR_DIGITS']},test:function(me,text,settings){return text.match(/^[0-9]{4}$/)!=null;}};var minLengthAndLetter={msg:function(me,settings){return translate_dict['INVALID_USERNAME']},test:function(me,text,settings){return(text.match(/[a-zA-Z]{1,}/)!=null&&text.length>=settings.minLength)}};$('#create_username').sfValidator({minLength:5,inputExp:/.*/gi,rules:[minLengthAndLetter],onTest:isReady});$('#create_pin').sfValidator({inputExp:/.*/gi,rules:[fourDigitOnly],onTest:isReady});_addPasswordValidator();};var restrictPin=function(event){var codes=[8,9,13,16,46,37,38,39,40];function allowed(code)
{return((c>=48&&c<=57)||(c>=96&&c<=105)||($.inArray(event.keyCode,codes)>-1))}
function special(code)
{return($.inArray(event.keyCode,codes)>-1)}
var c=event.keyCode;if(($(event.currentTarget).val().length>=4&&!special(c))||!allowed(c))
{return false;}};var restrictPinPaste=function(event){event.preventDefault();return false;};var isReady=function(){return true;};var username_timer;var usernameListen=function(){clearTimeout(username_timer);Forms.hide_error();$("#create_username").css("background-image","url('"+Globals.static_url+"img/ajax-loader.gif')").css("background-repeat","no-repeat").css("background-position","95% 50%");$("#create_username").parent().removeClass("has-success");username_timer=setTimeout(validateUsername,1000);}
var validateUsername=function(event){var username=$("#create_username").val();if(!username)
{$("#create_username").css("background-image","");return true;}
$.ajax({"url":"/"+Globals.version+"/account/checkusername","data":{'checkusername':username},"success":usernameResponse,"error":function(jqXHR,textStatus,errorThrown){},"type":"POST"});};var usernameResponse=function(data){if(!isProcessing){Forms.hide_error();$("#create_username").css("background-image","");if(data.response=="1"){Forms.show_error(translate_dict['USERNAME_IN_USE'],"create_username");}else if(data.response=="invalid"){Forms.show_error(translate_dict['INVALID_USERNAME'],"create_username");}else{$("#create_username").parent().addClass("has-success");}}};return{'init':init}})();
Forms=(function()
{var _ERROR_INVALID_FORMID=-104
var _show_error=function(message,where)
{_hide_message();_hide_error();where=where||'';if(where===''){$('#errorMessage').sfAlert({'style':'error','hideClose':true,'message':message});}else{error_element="<div class=\"form-error\" "+" id=\""+where+"_error\">"+
message+"</div>";if(where==="recaptcha_response_field"){where_to_insert="recaptcha_widget_div";$("#"+where_to_insert).parents(".recaptcha").addClass("has-error");$("#recaptcha_area").attr("style","border:2px solid #db1802;width: 322px!important;");}else{$("#"+where).parent().addClass("has-error");where_to_insert=where;}
$(error_element).insertAfter("#"+where_to_insert);$("#"+where).focus();if($("#"+where+"_show_hide_watcher").length>0){$("#"+where).parent().css({'height':''});$("#"+where+"_show_hide_watcher").click();$("#"+where+"_error").css({'top':'-20px','position':'relative'});}}}
var _hide_error=function(where)
{where=where||'';if(where!==''){$("#"+where).parent().removeClass("has-error");$("#"+where+"_error").remove();}else{$(".has-error").removeClass("has-error");$("#recaptcha_area").attr("style","");$("[id$=_error]").each(function(index){var this_id=$(this).attr('id');$(this).remove();var assoc_field=this_id.replace('_error','');$("#"+assoc_field).parent().css({'height':''});$("#"+assoc_field+"_show_hide_watcher").click();});}
$('#errorMessage').hide();}
var _hide_message=function()
{$('#statusMessage').hide();}
var existing_show_hide_links=[];var _showOrHidePassword=function(action,show_in,validator){action=action||"hide";show_in=show_in||'';if(show_in===''){return;}else if($("#"+show_in).length===0){return;}
$("#"+show_in).sfValidator("destroy");var show_hide_link=show_in+"_show_hide_link";if($.inArray(show_hide_link,existing_show_hide_links)==-1){$(window).resize(function(){_showOrHidePassword("hide",show_in,validator);});}
existing_show_hide_links.push(show_hide_link);$("#"+show_hide_link).remove();if(action==="hide"){var show_text=translate_dict['SHOW'];$("#"+show_in)[0].type='password';$("#"+show_in).addClass("has-show-hide-password");}else{var show_text=translate_dict['HIDE'];$("#"+show_in)[0].type='text';$("#"+show_in).addClass("has-show-hide-password");}
var class_list="text-primary";var style_list="position: relative; "+"display: none;"+"cursor: pointer;";var element_output="<span id=\""+show_hide_link+"\" "+"class=\""+class_list+"\" "+"style=\""+style_list+"\"><strong>"+show_text+"</strong></span>";$(element_output).insertAfter("#"+show_in);var css_top=-($("#"+show_in).outerHeight())+
($("#"+show_in).outerHeight()/2)-
($("#"+show_hide_link).outerHeight()/2);var css_left=$("#"+show_in).outerWidth()-
$("#"+show_hide_link).outerWidth()-
10;var parent_height=$("#"+show_hide_link).parent().height();$("#"+show_hide_link).css({'left':css_left,'top':css_top,'display':'inline-block'});$("#"+show_hide_link).parent().height(parent_height);if(action==="hide"){$("#"+show_hide_link).unbind("click");$("#"+show_hide_link).click(function(){_showOrHidePassword("show",show_in,validator);$("#"+show_in).focus();});}else{$("#"+show_hide_link).unbind("click");$("#"+show_hide_link).click(function(){_showOrHidePassword("hide",show_in,validator);$("#"+show_in).focus();});}
if(validator){validator();}
watcher_button=show_in+"_show_hide_watcher";watcher_button_html="<button style=\"display:none;\" "+"id=\""+watcher_button+"\"></button>";$(watcher_button_html).insertAfter("#"+show_hide_link);$("#"+watcher_button).click(function(){_showOrHidePassword("hide",show_in,validator);return false;});};return{'show_error':function(message,where){_show_error(message,where);},'hide_error':function(where){_hide_error(where);},'hide_message':function(){_hide_message();},'showOrHidePassword':function(action,show_in,validator){_showOrHidePassword(action,show_in,validator);}}})();
Layout=(function()
{return{handleLangChoice:function(e)
{e.preventDefault();query=window.location.search.substr(1).split("&");newQuery=["locale="+$(this).attr('lang')];query.forEach(function(item){if(item!==""&&!item.match(/^locale/)){newQuery.push(item);}});window.location="?"+newQuery.join("&");},setupLangMenu:function()
{$('.langChoice').click(Layout.handleLangChoice);var countryText=$('.langChoice[lang='+Globals.locale+']').text();$('#langDropLabel').html('<span class=\"uxicon uxicon-world\"></span> '+countryText+'<b class="caret"></b>');}}})();
var Login=Login||{};(function(){var init=function(){frameBreak();onLoadModal();formEventHandler();$("#editNewPasswordEmail").on("click",function(event){var span=$("#newPasswordEmail");var input=$("#newPasswordEmailText");if(input.is(":visible")&&!input.val()){input.focus();return;}
span.hide();$(this).hide();input.show().focus();$("#newPasswordModal").sfDialog('resize');});$(document.body).on("submit","#multifactor_verify_form",validateMultifactorForm);$(document.body).on('submit',"#login-form",validateLoginForm);$(document.body).on("click","#saveRecoveryCode",function(){$("#saveRecoveryCodeForm").submit()});$("#lostFactor").on('click',fetchFactors);$(window).on('resize',function(event){if(activeModal){setModalMode(activeModal);}});};var validateLoginForm=function(event)
{username=$("#username").val();pass=$("#password").val();Forms.hide_error();if(username.length==0)
{Forms.show_error(translate_dict['USERNAME_REQUIRED'],"username");$("#contentContainer").sfMsgOverlay("destroy");return false;}
else if(pass.length==0)
{Forms.show_error(translate_dict['PASSWORD_REQUIRED'],"password");$("#contentContainer").sfMsgOverlay("destroy");return false;}};var validateMultifactorForm=function(event)
{var input=$("#verification_code");Forms.hide_error();if(input.val()=="")
{Forms.show_error(translate_dict["ENTER_VERIFICATION_CODE"],"verification_code");$("#contentContainer").sfMsgOverlay("destroy");return false;}};var activeModal=null;var setModalMode=function(which)
{activeModal=which;$("#contentContainer").css('display','none');if(which=='o365')
{var modal=$(".sf-dialog-modal");var top=parseInt(modal.css('top'))+parseInt(modal.css('height'))+50;$("#officeLogoFloater").css({'position':'absolute','left':modal.css('left'),'z-index':150000001,'float':'none','display':'block','top':top+'px'});$("#footerFloater").css({'position':'absolute','bottom':'10px','z-index':150000001,'width':'100%','text-align':'center','display':'block'});}}
var removeModalMode=function()
{activeModal=null;$("#contentContainer").css('display','block');$("#officeLogoFloater").hide();$("#footerFloater").hide();}
var newPasswordSubmit=function()
{$(".alert").remove();if($('#newPasswordModalNewPassword').val()!=$('#newPasswordModalNewPasswordConfim').val())
{$("<div />").sfAlert({style:"error",message:translate_dict["PASSWORDS_DONT_MATCH"]}).prependTo("#alertStatus");}
else if($("#newPasswordModalNewPassword").val().replace(/\s/g,"")=="")
{$("<div />").sfAlert({style:"error",message:translate_dict["PROVIDE_A_PASSWORD"]}).prependTo("#alertStatus");$("#newPasswordModalNewPassword").focus();}
else
{$('#temp-password-form').submit();}
return false;};var onLoadModal=function()
{var modal=$("#onLoadModal");if(modal.length==0)
{return;}
var whichModal=modal.attr('name');switch(whichModal)
{case'newPassword':modal.sfDialog({cancelDisabled:true,buttons:[{text:translate_dict['CONTINUE_TO_OFFICE_365'],onClick:function()
{newPasswordSubmit();}}],buttonAlign:'left',autoResize:true,onOpen:function(me,a,b){$(me).find('.modal-footer').css('background-color','white');setModalMode('o365');}});$("#newPasswordModalNewPassword").focus();break;case'expiredPassword':modal.sfDialog({cancelDisabled:true,buttons:[{text:translate_dict['BACK_TO_LOGIN'],onClick:function($sfDialog){$sfDialog.sfDialog('close');removeModalMode();}}],buttonAlign:'left',onOpen:function(me,a,b){$(me).find('.modal-footer').css('background-color','white');setModalMode('o365');submitPasswordResetRequest($("#username").val(),2);}});break;}}
var formEventHandler=function()
{$(document.body).on("click","#submitBtn",function(event){$('#login-form').submit();return false;});$(document.body).on('keypress','#password,#sms',function(event)
{if(event.keyCode==13)
{this.form.submit();return false;}});$(document.body).on('keypress','#newPasswordModalNewPasswordConfim',function(event)
{if(event.keyCode==13)
{newPasswordSubmit();return false;}});var usernameField=$("#username");var passwordField=$("#password");if(usernameField.val())
{passwordField.focus();}
else
{usernameField.focus();}}
var fixUrl=function(url){params='';try{params=window.location.search;}
catch(e){}
if(Globals.version){return"/"+Globals.version+url+params;}
return url+params;};var submitPasswordResetRequest=function(username,type)
{if(!username)
{return;}
$.ajax({"url":fixUrl("/login/sendpasswordreset"),"data":{"user":username,"type":type},"success":function(data){passwordResetConfirm(data,type)},"type":"POST"});}
var fetchFactors=function(event){Forms.hide_error();factors=$("#codeRecoveryContent");if(factors.length>0)
{$("#formContainer").hide();factors.show();return false;}
var data=$(event.currentTarget).attr('data-action');$.ajax({"url":fixUrl("/login/fetchfactors"),"data":{'action':data},"success":displayFactors,"type":"POST"});return false;};var displayFactors=function(data)
{$("#contentContainer").append(data);$("#formContainer").hide();$("#codeRecoveryContent").show();$("#cancelMultifactorSelection").on('click',function(){$("#formContainer").show();$("#codeRecoveryContent").hide();Forms.hide_error();$('#verification_code').focus();return false;});$("#submitMultiFactorSelection").on('click',submitMultifactorSelection)};var submitMultifactorSelection=function()
{factors=$("input[name=factor_id]");factor_id=$("input[name=factor_id]:checked").attr('value');if(factors.length>0&&!factor_id)
{Forms.show_error(translate_dict["PLEASE_CHOOSE_FACTOR"]);return false;}
$("#multifactorSelectionForm").submit();return false;};var passwordResetConfirm=function(data,type)
{if(data.success==1&&type==1)
{$("#requestPasswordContent").hide();$("#confirmContent").show();$(".sf-dialog-title").text(translate_dict['WORK_IS_DONE']);$("#newPasswordModal").sfDialog('setButtons',[{text:translate_dict['BACK_TO_LOGIN'],onClick:function($sfDialog){$sfDialog.sfDialog('close');removeModalMode();}}]).sfDialog('resize');setModalMode('o365');}}
var wireupForgotPasswordPASS=function(){$("#forgotPasswordLink").on("click",forgotPasswordClickHandlerPASS);}
var forgotPasswordClickHandlerPASS=function(event)
{$("#newPasswordModal").sfDialog({cancelDisabled:true,buttons:[{text:translate_dict['REQUEST_PASSWORD_RESET'],onClick:function($sfDialog){if(!$("#newPasswordEmailText").val())
{$("#newPasswordEmailText").focus();return;}
submitPasswordResetRequest($("#newPasswordEmailText").val(),1);}},{text:translate_dict['CANCEL'],cancel:true,onClick:function($sfDialog){removeModalMode();}}],buttonAlign:'left',onOpen:function(me,a,b){var user=$("#username").val();$("#requestPasswordContent").show();$("#confirmContent").hide();setModalMode('o365');$(me).find('.modal-footer').css('background-color','white');$("#newPasswordEmail").text(user);$("#newPasswordEmailText").val(user);if(!user)
{$("#newPasswordEmail").hide();$("#newPasswordEmailText").show().focus();$("#editNewPasswordEmail").hide();}
else
{$("#newPasswordEmail").show();$("#newPasswordEmailText").hide();$("#editNewPasswordEmail").show();}}}).sfDialog('resize');return false;};var frameBreak=function()
{if(top!=self)top.location=location;};Login.init=init;Login.wireupForgotPasswordPASS=wireupForgotPasswordPASS;})();
ResetPassword=(function(){var error_map;var init=function(){$("#reset_username").focus();$("#submitBtn").click(validateFirstForm);setupValidators();Forms.showOrHidePassword("hide","reset_new_pwd",_addPasswordValidator);$(document.body).on('keypress','#reset_username,#reset_new_pwd',function(event){if(event.keyCode==13)
{$("#reset_username").blur();$("#reset_new_pwd").blur();validateFirstForm();}});setTabTryAgain=0;function setRecaptchaTabIndex(){setTimeout(function(){if($("#recaptcha_response_field").length>0){$("#recaptcha_response_field").attr("tabindex","3");$("#recaptcha_privacy").attr("tabindex","4");}else{if(setTabTryAgain<10){setRecaptchaTabIndex();}
setTabTryAgain+=1;}},500);}
setRecaptchaTabIndex();error_map={'reset_authcode':{'missing':translate_dict['AUTHCODE_REQUIRED'],},'reset_username':{'missing':translate_dict['USERNAME_REQUIRED'],'notfound':translate_dict['RESET_INVALID_USER'],},'reset_email':{'invalid':translate_dict['INVALID_USER_EMAIL'],'missing':translate_dict['EMAIL_REQUIRED']},'reset_new_pwd':{'missing':translate_dict['PASSWORD_REQUIRED'],'invalid':translate_dict['INVALID_PASSWORD'],'matchhint':translate_dict['PASSWORD_MATCH_HINT'],'fail30days':translate_dict['PASSWORD_30DAYS'],'faillast5':translate_dict['PASSWORD_LAST5'],},'reset_confirm_pwd':{'mismatch':translate_dict['PASSWORDS_MISMATCH'],},'reset_pwd_hint':{'missing':translate_dict['PWD_HINT_REQUIRED'],},'verification_code':{'missing':translate_dict['VERIFICATION_CODE_REQUIRED'],'invalid':translate_dict['VERIFICATION_CODE_INVALID'],},'recaptcha_response_field':{'invalid':translate_dict['ERROR_CAPTCHA'],'missing':translate_dict['ERROR_CAPTCHA']},'default':translate_dict['ERROR_MSG_DEFAULT'],'resetfail':translate_dict['RESET_PWD_FAIL']};};var validateFirstForm=function(event)
{var inputs=$("#reset_submit_form").find('input');for(var i=0;i<inputs.length;i++)
{var input=$(inputs[i]);if(input.val()=="")
{return _setError(input.attr('id'),'missing')}
switch(input.attr('id'))
{case'reset_email':if(!input.val().match("@")||!input.val().match(/\.{1,}/))
{return _setError(input.attr('id'),'invalid');}
break;case'reset_new_pwd':if(input.val()==$("#reset_username").val())
{return _setError(input.attr('id'),'matches_username');}
break;}}
_submitFirstForm(event);return false;};var _submitFirstForm=function(event)
{$("#submitBtn").addClass('disabled');var the_form=$("#submitBtn").closest('form');var json={};the_form.find('input').each(function(i,elm){json[$(elm).attr('name')]=$(elm).attr('value');});$("#contentContainer").sfMsgOverlay({'message':translate_dict['PROCESSING']});$.ajax({"url":the_form.attr('action'),"data":json,"success":_handleFirstResponse,"error":function(jqXHR,textStatus,errorThrown){$("#submitBtn").removeClass('disabled');},"type":"POST"});return false;};var _handleFirstResponse=function(data)
{_clearError();$("#submitBtn").removeClass('disabled');$("#contentContainer").sfMsgOverlay('destroy');if(data.error){if(data.error.id){_setError(data.error.id,data.error.reason);}else{_setError('',error_map[data.error.reason]);}
if($("#recaptcha_reload").length>0){$("#recaptcha_reload").click();}
return false;}else if(data.html_response){$("#formContainer").html(data.html_response);$("#lostFactor").off();$("#multifactorSubmitBtn").off();$("#lostFactor").on('click',_listAlternativeFactors);$("#multifactorSubmitBtn").on('click',_submit2FaForm)}else{document.location=data.response;}};var _listAlternativeFactors=function(event){Forms.hide_error();if($("#codeRecoveryContent").length>0){$("#formContainer").hide();$("#codeRecoveryContent").show();return false;}
$("#contentContainer").sfMsgOverlay({'message':translate_dict['PROCESSING']});params='';try{params=window.location.search;}catch(e){}
params=params.replace(/action=[^&]*[&]/,"action=fetchfactors&");url="/"+Globals.version+"/account/reset/"+params;$.ajax({"url":url,"success":displayFactors,"type":"POST"});return false;};var displayFactors=function(data)
{$("#contentContainer").sfMsgOverlay('destroy');$("#contentContainer").append(data);$("#formContainer").hide();$("#codeRecoveryContent").show();$("#cancelMultifactorSelection").on('click',function(){$("#formContainer").show();$("#codeRecoveryContent").hide();Forms.hide_error();$('#verification_code').focus();return false;});$("#submitMultiFactorSelection").on('click',submitMultifactorSelection)};var submitMultifactorSelection=function(){factors=$("input[name=factor_id]");factor_id=$("input[name=factor_id]:checked").attr('value');if(factors.length>0&&!factor_id){Forms.show_error(translate["PLEASE_CHOOSE_FACTOR"]);return false;}
json={}
$("input[name=factor_id]:checked").each(function(i,elm){json[$(elm).attr('name')]=$(elm).attr('value');});$("#contentContainer").sfMsgOverlay({'message':translate_dict['PROCESSING']});$.ajax({"url":$("#multifactorSelectionForm").attr('action'),"data":json,"success":handleMultifactorSelection,"error":function(jqXHR,textStatus,errorThrown){$("#multifactorSubmitBtn").removeClass('disabled');},"type":"POST"});return false;};var handleMultifactorSelection=function(data){$("#contentContainer").sfMsgOverlay('destroy');$("#codeRecoveryContent").hide();$("#formContainer").show();if(data.error){}
$("#codeRecoveryContent").remove();$("#formContainer").html(data.html_response);$("#lostFactor").on('click',_listAlternativeFactors);$("#multifactorSubmitBtn").on('click',_submit2FaForm)
return false;};var _submit2FaForm=function(event)
{$("#multifactorSubmitBtn").addClass('disabled');var the_form=$("#multifactorSubmitBtn").closest('form');var json={};the_form.find('input').each(function(i,elm){json[$(elm).attr('name')]=$(elm).attr('value');});$("#contentContainer").sfMsgOverlay({'message':translate_dict['PROCESSING']});$.ajax({"url":the_form.attr('action'),"data":json,"success":_handle2FaResponse,"error":function(jqXHR,textStatus,errorThrown){$("#multifactorSubmitBtn").removeClass('disabled');},"type":"POST"});return false;};var _handle2FaResponse=function(data){_clearError();$("#contentContainer").sfMsgOverlay('destroy');$("#multifactorSubmitBtn").removeClass('disabled');if(data.error){if(data.error.id){_setError(data.error.id,data.error.reason);}else{_setError('',error_map[data.error.reason]);}
return false;}else{document.location=data.response;}};var _setError=function(id,reason)
{Forms.show_error(error_map[id][reason],id);return false;};var _clearError=function()
{Forms.hide_error();};var _addPasswordValidator=function(elm)
{var notStartOrEndWithSpace={msg:function(me,settings){return translate_dict['NOT_BEGIN_OR_END_WITH_SPACE']},test:function(me,text,settings){return!text.match(/^\s|\s$/);}};if(!elm)
{elm=$('#reset_new_pwd');}
elm.sfValidator({minLength:9,maxLength:50,inputExp:/.*/gi,rules:[notStartOrEndWithSpace,$.fn.sfValidator.rules.lowerCase,$.fn.sfValidator.rules.upperCase,$.fn.sfValidator.rules.hasNum,$.fn.sfValidator.rules.checkLength],});};var _addPasswordConfirmation=function()
{var confirmPwdNotMatch={msg:function(me,settings){return translate_dict['PASSWORDS_MISMATCH']},test:function(me,text,settings){return text==$('#reset_new_pwd').val();}};elm=$('#reset_confirm_pwd');elm.sfValidator({minLength:9,maxLength:50,inputExp:/.*/gi,rules:[confirmPwdNotMatch],});};var setupValidators=function()
{_addPasswordValidator();_addPasswordConfirmation($('#reset_new_pwd'));};var isReady=function()
{};var tabToRecaptcha=function(event){var TABKEY=9;isShift=window.event.shiftKey?true:false;if(event.keyCode==TABKEY&&!isShift){$("#recaptcha_response_field").focus();return false;}};return{'init':init,'se':_setError}})();